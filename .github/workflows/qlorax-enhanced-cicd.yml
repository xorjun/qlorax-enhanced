name: ğŸš€ QLORAX CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  schedule:
    # Daily performance check at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_full_pipeline:
        description: 'Run full training pipeline'
        required: false
        default: 'false'
        type: boolean
      synthetic_samples:
        description: 'Number of synthetic samples for InstructLab'
        required: false
        default: '50'
        type: string

env:
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: v1

jobs:
  # ============================================================================
  # PREPARATION & VALIDATION
  # ============================================================================
  
  code-quality:
    name: ğŸ§¹ Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: pip-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
          
      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort mypy flake8 bandit safety
          pip install -r requirements.txt
          
      - name: ğŸ¨ Code Formatting Check
        run: |
          echo "ğŸ“ Checking code formatting with black..."
          black --check --diff .
          
      - name: ğŸ“‹ Import Sorting Check
        run: |
          echo "ğŸ“‹ Checking import sorting with isort..."
          isort --check-only --diff .
          
      - name: ğŸ” Type Checking
        run: |
          echo "ğŸ” Type checking with mypy..."
          mypy scripts/ --ignore-missing-imports
          
      - name: ğŸ“ Code Linting
        run: |
          echo "ğŸ“ Linting with flake8..."
          flake8 scripts/ --max-line-length=88 --extend-ignore=E203,W503
          
      - name: ğŸ” Security Scanning
        run: |
          echo "ğŸ” Security scanning with bandit..."
          bandit -r scripts/ -f json -o security-report.json || true
          
      - name: ğŸ“Š Dependency Vulnerability Check
        run: |
          echo "ğŸ“Š Checking for vulnerable dependencies..."
          safety check --json --output safety-report.json || true
          
      - name: ğŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            security-report.json
            safety-report.json

  # ============================================================================
  # TESTING MATRIX
  # ============================================================================
  
  test-matrix:
    name: ğŸ§ª Test Suite
    runs-on: ${{ matrix.os }}
    needs: code-quality
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11']
        exclude:
          # Reduce matrix size for faster CI
          - os: windows-latest
            python-version: '3.9'
            
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: pip-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
          
      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist
          pip install -r requirements.txt
          pip install -r requirements-instructlab.txt
          
      - name: ğŸ§ª Run Unit Tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          python -m pytest tests/ -v --cov=scripts --cov-report=xml --cov-report=term-missing
          
      - name: âœ… System Validation
        run: |
          echo "âœ… Running system validation..."
          python validate_system.py || true
          
      - name: ğŸ”¬ InstructLab Integration Test
        run: |
          echo "ğŸ”¬ Testing InstructLab integration..."
          python test_integration.py || true
          
      - name: ğŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v3
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # ============================================================================
  # MODEL TRAINING & EVALUATION
  # ============================================================================
  
  training-pipeline:
    name: ğŸ¯ Training Pipeline
    runs-on: ubuntu-latest
    needs: test-matrix
    if: github.event_name == 'push' || github.event.inputs.run_full_pipeline == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ Cache Dependencies & Models
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/huggingface
          key: training-${{ env.CACHE_VERSION }}-${{ hashFiles('**/requirements*.txt') }}
          
      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-instructlab.txt
          
      - name: ğŸ§ª InstructLab Data Generation
        run: |
          echo "ğŸ§ª Generating synthetic training data..."
          python scripts/instructlab_integration.py \
            --test-mode \
            --samples ${{ github.event.inputs.synthetic_samples || '25' }} \
            --domain machine_learning
            
      - name: ğŸƒâ€â™‚ï¸ Dry Run Training
        run: |
          echo "ğŸƒâ€â™‚ï¸ Running training dry run..."
          python quick_start.py --demo --mode enhanced
          
      - name: ğŸ“Š Quality Gate Check
        run: |
          echo "ğŸ“Š Running quality gate validation..."
          python scripts/quality_gates.py --stage dry_run
          
      - name: ğŸ’¾ Cache Training Artifacts
        uses: actions/cache@v3
        with:
          path: |
            models/
            results/
          key: training-artifacts-${{ github.sha }}

  # ============================================================================
  # BENCHMARKING & PERFORMANCE
  # ============================================================================
  
  performance-benchmark:
    name: ğŸ“Š Performance Benchmark
    runs-on: ubuntu-latest
    needs: training-pipeline
    if: always() && (needs.training-pipeline.result == 'success' || github.event_name == 'schedule')
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ Restore Training Cache
        uses: actions/cache@v3
        with:
          path: |
            models/
            results/
          key: training-artifacts-${{ github.sha }}
          
      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-instructlab.txt
          
      - name: ğŸ“ˆ Run Performance Benchmarks
        run: |
          echo "ğŸ“ˆ Running comprehensive benchmarks..."
          python scripts/enhanced_benchmark.py \
            --model models/demo-qlora-model \
            --test-data data/test_data.jsonl \
            --output results/benchmark_results.json
            
      - name: ğŸ¯ Evaluate Quality Gates
        id: quality_check
        run: |
          echo "ğŸ¯ Evaluating quality gates..."
          python scripts/quality_gates.py --stage evaluation
          echo "quality_passed=$?" >> $GITHUB_OUTPUT
          
      - name: ğŸ“Š Generate Performance Report
        run: |
          echo "ğŸ“Š Generating performance report..."
          python scripts/project_summary.py > performance_report.md
          
      - name: ğŸ“¤ Upload Benchmark Results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: |
            results/
            performance_report.md
            
      - name: ğŸ’¬ Comment Performance Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = './performance_report.md';
            
            if (fs.existsSync(path)) {
              const report = fs.readFileSync(path, 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ“Š Performance Report\n\n${report}`
              });
            }

  # ============================================================================
  # DOCKER BUILD & DEPLOYMENT
  # ============================================================================
  
  docker-build:
    name: ğŸ³ Docker Build & Push
    runs-on: ubuntu-latest
    needs: [training-pipeline, performance-benchmark]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“Š Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: ğŸ—ï¸ Build and Push Training Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.training
          push: true
          tags: ghcr.io/${{ github.repository }}/training:${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: ğŸš€ Build and Push Serving Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.serve
          push: true
          tags: ghcr.io/${{ github.repository }}/serve:${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # RELEASE & DEPLOYMENT
  # ============================================================================
  
  release-deployment:
    name: ğŸš€ Release & Deploy
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Download Benchmark Results
        uses: actions/download-artifact@v3
        with:
          name: benchmark-results-${{ github.sha }}
          path: ./release-artifacts/
          
      - name: ğŸ“ Generate Release Notes
        id: release_notes
        run: |
          echo "Generating release notes..."
          cat > release_notes.md << 'EOF'
          ## ğŸš€ QLORAX Enhanced Release ${{ github.ref_name }}
          
          ### âœ¨ Features
          - ğŸ¯ Enhanced QLoRA fine-tuning pipeline
          - ğŸ”¬ InstructLab synthetic data integration
          - ğŸ³ Production Docker containers
          - ğŸ“Š Comprehensive evaluation framework
          
          ### ğŸ“Š Performance Metrics
          $(cat ./release-artifacts/performance_report.md 2>/dev/null || echo "Performance report not available")
          
          ### ğŸ³ Docker Images
          - Training: `ghcr.io/${{ github.repository }}/training:${{ github.ref_name }}`
          - Serving: `ghcr.io/${{ github.repository }}/serve:${{ github.ref_name }}`
          
          ### ğŸ“š Documentation
          - [Setup Guide](docs/setup/installation-complete.md)
          - [InstructLab Guide](docs/guides/instructlab-integration-guide.md)
          - [Complete Documentation](docs/)
          EOF
          
      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: QLORAX Enhanced ${{ github.ref_name }}
          body_path: release_notes.md
          files: |
            ./release-artifacts/**
          draft: false
          prerelease: false
          generate_release_notes: true
          
      - name: ğŸ“¢ Notify Success
        run: |
          echo "ğŸ‰ Release ${{ github.ref_name }} deployed successfully!"
          echo "ğŸ³ Docker images available at ghcr.io/${{ github.repository }}"
          echo "ğŸ“š Documentation: https://github.com/${{ github.repository }}"

  # ============================================================================
  # CLEANUP & NOTIFICATIONS
  # ============================================================================
  
  cleanup-notify:
    name: ğŸ§¹ Cleanup & Notify
    runs-on: ubuntu-latest
    needs: [code-quality, test-matrix, training-pipeline, performance-benchmark, docker-build]
    if: always()
    
    steps:
      - name: ğŸ“Š Pipeline Status Summary
        run: |
          echo "## ğŸ“‹ Pipeline Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§¹ Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª Tests: ${{ needs.test-matrix.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¯ Training: ${{ needs.training-pipeline.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š Benchmarks: ${{ needs.performance-benchmark.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ³ Docker: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸš¨ Failure Notification
        if: failure()
        run: |
          echo "âŒ Pipeline failed! Check the logs for details."
          echo "ğŸ“§ Consider setting up Slack/email notifications for production use."
          
      - name: âœ… Success Notification
        if: success()
        run: |
          echo "âœ… Pipeline completed successfully!"
          echo "ğŸš€ All quality gates passed and artifacts are ready."

# ============================================================================
# WORKFLOW CONFIGURATION
# ============================================================================

# Cancel in-progress workflows for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Default permissions
permissions:
  contents: read
  packages: write
  pull-requests: write
  issues: write