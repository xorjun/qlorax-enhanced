name: ğŸ§ª InstructLab Integration Tests

on:
  push:
    paths:
      - 'scripts/instructlab_integration.py'
      - 'configs/instructlab-config.yaml'
      - 'requirements-instructlab.txt'
      - 'instructlab/**'
  pull_request:
    paths:
      - 'scripts/instructlab_integration.py'
      - 'configs/instructlab-config.yaml'
      - 'requirements-instructlab.txt'
      - 'instructlab/**'
  workflow_dispatch:
    inputs:
      test_samples:
        description: 'Number of test samples to generate'
        required: false
        default: '10'
        type: string
      test_domain:
        description: 'Test domain for taxonomy'
        required: false
        default: 'test_domain'
        type: string

jobs:
  instructlab-tests:
    name: ğŸ”¬ InstructLab Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: instructlab-${{ hashFiles('**/requirements-instructlab.txt') }}
          
      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-instructlab.txt
          
      - name: ğŸ—ï¸ Setup Test Environment
        run: |
          mkdir -p instructlab/taxonomy
          mkdir -p data/instructlab_generated
          mkdir -p logs
          
      - name: ğŸ§ª Test Taxonomy Creation
        run: |
          echo "ğŸ§ª Testing taxonomy creation..."
          python -c "
          from scripts.instructlab_integration import QLORAXInstructLab
          instructlab = QLORAXInstructLab()
          taxonomy_file = instructlab.create_taxonomy_structure('${{ github.event.inputs.test_domain || 'test_domain' }}')
          print(f'âœ… Taxonomy created: {taxonomy_file}')
          "
          
      - name: ğŸ”¬ Test Synthetic Data Generation
        run: |
          echo "ğŸ”¬ Testing synthetic data generation..."
          python scripts/instructlab_integration.py \
            --test-mode \
            --samples ${{ github.event.inputs.test_samples || '10' }} \
            --domain ${{ github.event.inputs.test_domain || 'test_domain' }}
            
      - name: âœ… Test Data Validation
        run: |
          echo "âœ… Testing data validation..."
          python -c "
          from scripts.instructlab_integration import QLORAXInstructLab
          from pathlib import Path
          
          instructlab = QLORAXInstructLab()
          
          # Find generated data file
          data_files = list(Path('data/instructlab_generated').glob('synthetic_data_*.jsonl'))
          if data_files:
              results = instructlab.validate_generated_data(str(data_files[0]))
              print(f'âœ… Validation results: {results}')
          else:
              print('âš ï¸ No generated data files found')
          "
          
      - name: ğŸ”— Test Data Integration
        run: |
          echo "ğŸ”— Testing data integration..."
          python -c "
          from scripts.instructlab_integration import QLORAXInstructLab
          from pathlib import Path
          
          instructlab = QLORAXInstructLab()
          
          # Find generated data file
          data_files = list(Path('data/instructlab_generated').glob('synthetic_data_*.jsonl'))
          if data_files and Path('data/curated.jsonl').exists():
              combined = instructlab.integrate_with_qlorax_training(
                  synthetic_data_path=str(data_files[0]),
                  existing_data_path='data/curated.jsonl',
                  output_path='data/test_combined.jsonl'
              )
              print(f'âœ… Data integration completed: {combined}')
          else:
              print('âš ï¸ Required files not available for integration test')
          "
          
      - name: ğŸ“¤ Upload Test Artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: instructlab-test-results
          path: |
            data/instructlab_generated/
            data/test_combined.jsonl
            instructlab/taxonomy/
            logs/

  compatibility-test:
    name: ğŸ”„ Compatibility Test
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.11']
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-instructlab.txt
          
      - name: ğŸ§ª Basic InstructLab Import Test
        run: |
          python -c "
          try:
              from scripts.instructlab_integration import QLORAXInstructLab
              print('âœ… InstructLab integration imports successfully')
          except Exception as e:
              print(f'âŒ Import failed: {e}')
              exit(1)
          "
          
      - name: ğŸ”¬ Mock Data Generation Test
        run: |
          python -c "
          from scripts.instructlab_integration import QLORAXInstructLab
          instructlab = QLORAXInstructLab()
          result = instructlab._generate_mock_data(5)
          print(f'âœ… Mock data generation successful: {result}')
          "