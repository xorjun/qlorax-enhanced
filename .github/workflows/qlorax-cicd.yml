# üöÄ QLORAX Automated Fine-Tuning CI/CD Pipeline
# Implements the complete workflow from synthetic data generation to deployment

name: QLORAX QLoRA Fine-Tuning Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'data/**'
      - 'configs/**'
      - 'scripts/**'
      - 'docs/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain for synthetic data generation'
        required: true
        default: 'artificial_intelligence'
        type: choice
        options:
          - artificial_intelligence
          - machine_learning
          - data_science
          - healthcare
          - finance
      num_samples:
        description: 'Number of synthetic samples to generate'
        required: true
        default: '25'
        type: string
      force_training:
        description: 'Force training even if dry run fails'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.11"
  WANDB_PROJECT: "qlorax-automated"
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}

jobs:
  # Phase 1: Prep & Trigger
  data-preparation:
    name: "üìä Data Generation & Preparation"
    runs-on: ubuntu-latest
    outputs:
      data-file: ${{ steps.data-gen.outputs.data-file }}
      sample-count: ${{ steps.data-gen.outputs.sample-count }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements-instructlab.txt
        
    - name: Generate synthetic data with InstructLab
      id: data-gen
      run: |
        echo "üîÑ Generating synthetic data..."
        DOMAIN="${{ github.event.inputs.domain || 'artificial_intelligence' }}"
        SAMPLES="${{ github.event.inputs.num_samples || '25' }}"
        
        python -c "
        import sys
        sys.path.append('.')
        from scripts.instructlab_integration import QLORAXInstructLab
        import os
        
        ql = QLORAXInstructLab()
        output_file = ql.generate_synthetic_data('$DOMAIN', int('$SAMPLES'))
        print(f'Generated data file: {output_file}')
        
        # Set GitHub Actions outputs
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'data-file={output_file}\n')
            f.write(f'sample-count=$SAMPLES\n')
        "
        
    - name: Validate generated data
      run: |
        echo "‚úÖ Validating generated data..."
        python scripts/test_model.py --validate-data-only
        
    - name: Upload generated data as artifact
      uses: actions/upload-artifact@v4
      with:
        name: synthetic-data
        path: data/instructlab_generated/
        retention-days: 30

  # Job 1: CPU Dry Run (Unit Tests + 1 training iteration)
  dry-run-validation:
    name: "üß™ CPU Dry Run & Validation"
    runs-on: ubuntu-latest
    needs: data-preparation
    outputs:
      dry-run-passed: ${{ steps.dry-run.outputs.passed }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements-instructlab.txt
        
    - name: Download synthetic data
      uses: actions/download-artifact@v4
      with:
        name: synthetic-data
        path: data/instructlab_generated/
        
    - name: System validation
      run: |
        echo "üîç Running system validation..."
        python validate_system.py
        
    - name: Integration tests
      run: |
        echo "üß™ Running integration tests..."
        python test_integration.py
        
    - name: CPU dry run training (1 iteration)
      id: dry-run
      run: |
        echo "‚ö° Running CPU dry run training..."
        python scripts/enhanced_training.py \
          --config configs/test-config.yaml \
          --dry-run \
          --max-steps 1 \
          --output-dir test_output/dry-run
        
        # Check if dry run passed
        if [ $? -eq 0 ]; then
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Dry run passed!"
        else
          echo "passed=false" >> $GITHUB_OUTPUT
          echo "‚ùå Dry run failed!"
          exit 1
        fi

  # Job 2: Dockerized GPU Training
  gpu-training:
    name: "üöÄ Dockerized GPU Training"
    runs-on: ubuntu-latest
    needs: [data-preparation, dry-run-validation]
    if: needs.dry-run-validation.outputs.dry-run-passed == 'true' || github.event.inputs.force_training == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Download synthetic data
      uses: actions/download-artifact@v4
      with:
        name: synthetic-data
        path: data/instructlab_generated/
        
    - name: Build training container
      run: |
        echo "üê≥ Building Docker training container..."
        docker build -f Dockerfile.training -t qlorax-trainer:${{ github.sha }} .
        
    - name: Run QLoRA fine-tuning in container
      run: |
        echo "üéØ Running QLoRA fine-tuning..."
        docker run --rm \
          -v ${{ github.workspace }}/models:/app/models \
          -v ${{ github.workspace }}/data:/app/data \
          -e WANDB_API_KEY=${{ secrets.WANDB_API_KEY }} \
          -e HF_TOKEN=${{ secrets.HF_TOKEN }} \
          qlorax-trainer:${{ github.sha }} \
          python run_enhanced_training.py \
          --config configs/production-config.yaml \
          --experiment-name "cicd-${{ github.sha }}"
          
    - name: Upload trained model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: |
          models/enhanced-qlora-*/
          !models/enhanced-qlora-*/checkpoints/
        retention-days: 30

  # Job 3: Evaluation
  model-evaluation:
    name: "üìà Model Evaluation & Quality Gates"
    runs-on: ubuntu-latest
    needs: [gpu-training]
    outputs:
      evaluation-passed: ${{ steps.quality-gate.outputs.passed }}
      bert-f1: ${{ steps.evaluation.outputs.bert-f1 }}
      rouge-l: ${{ steps.evaluation.outputs.rouge-l }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements-instructlab.txt
        
    - name: Download trained model
      uses: actions/download-artifact@v4
      with:
        name: trained-model
        path: models/
        
    - name: Run comprehensive evaluation
      id: evaluation
      run: |
        echo "üìä Running comprehensive evaluation..."
        python scripts/enhanced_benchmark.py \
          --model-path models/enhanced-qlora-* \
          --test-data data/test_data.jsonl \
          --output results/cicd-evaluation.json
          
        # Extract key metrics
        BERT_F1=$(python -c "import json; print(json.load(open('results/cicd-evaluation.json'))['metrics']['bert_scores']['bert_f1'])")
        ROUGE_L=$(python -c "import json; print(json.load(open('results/cicd-evaluation.json'))['metrics']['rouge_scores']['rougeL'])")
        
        echo "bert-f1=$BERT_F1" >> $GITHUB_OUTPUT
        echo "rouge-l=$ROUGE_L" >> $GITHUB_OUTPUT
        
    - name: Quality gate evaluation
      id: quality-gate
      run: |
        echo "üéØ Evaluating quality gates..."
        
        # Define thresholds (matching your successful results)
        BERT_THRESHOLD=0.90
        ROUGE_THRESHOLD=0.85
        
        BERT_F1="${{ steps.evaluation.outputs.bert-f1 }}"
        ROUGE_L="${{ steps.evaluation.outputs.rouge-l }}"
        
        echo "üìä Results: BERT F1: $BERT_F1, ROUGE-L: $ROUGE_L"
        echo "üéØ Thresholds: BERT F1: ‚â•$BERT_THRESHOLD, ROUGE-L: ‚â•$ROUGE_THRESHOLD"
        
        if (( $(echo "$BERT_F1 >= $BERT_THRESHOLD" | bc -l) )) && (( $(echo "$ROUGE_L >= $ROUGE_THRESHOLD" | bc -l) )); then
          echo "‚úÖ Quality gates PASSED!"
          echo "passed=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Quality gates FAILED!"
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: Upload evaluation results
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-results
        path: results/
        retention-days: 90

  # Job 4: Publish Artifacts
  publish-artifacts:
    name: "üì¶ Publish Model Artifacts"
    runs-on: ubuntu-latest
    needs: [model-evaluation]
    if: needs.model-evaluation.outputs.evaluation-passed == 'true' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download trained model
      uses: actions/download-artifact@v4
      with:
        name: trained-model
        path: models/
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install huggingface_hub
      run: |
        pip install huggingface_hub
        
    - name: Push LoRA adapters to Hugging Face Hub
      run: |
        echo "ü§ó Publishing to Hugging Face Hub..."
        python -c "
        from huggingface_hub import HfApi
        import os
        
        api = HfApi(token=os.environ['HF_TOKEN'])
        
        # Create repository if it doesn't exist
        try:
            api.create_repo('qlorax-enhanced-model-${{ github.sha }}', private=False)
        except:
            pass  # Repository might already exist
            
        # Upload model files
        api.upload_folder(
            folder_path='models/enhanced-qlora-*/',
            repo_id='qlorax-enhanced-model-${{ github.sha }}',
            commit_message='Automated QLORAX model deployment - ${{ github.sha }}'
        )
        "

  # Job 4: Dockerized Serving Build
  build-serving-container:
    name: "üê≥ Build Deployment Container"
    runs-on: ubuntu-latest
    needs: [model-evaluation]
    if: needs.model-evaluation.outputs.evaluation-passed == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Download trained model
      uses: actions/download-artifact@v4
      with:
        name: trained-model
        path: models/
        
    - name: Build and push serving container
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.serve
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/qlorax-serve:latest
          ${{ secrets.DOCKER_USERNAME }}/qlorax-serve:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Deployment notification
  deployment-ready:
    name: "üéâ Deployment Ready"
    runs-on: ubuntu-latest
    needs: [publish-artifacts, build-serving-container]
    if: always() && (needs.publish-artifacts.result == 'success' || needs.build-serving-container.result == 'success')
    
    steps:
    - name: Deployment summary
      run: |
        echo "üéâ QLORAX CI/CD Pipeline Completed Successfully!"
        echo "=================================================="
        echo "üìä Model Performance:"
        echo "   BERT F1: ${{ needs.model-evaluation.outputs.bert-f1 }}"
        echo "   ROUGE-L: ${{ needs.model-evaluation.outputs.rouge-l }}"
        echo ""
        echo "üöÄ Deployment Options:"
        echo "   ü§ó HuggingFace: qlorax-enhanced-model-${{ github.sha }}"
        echo "   üê≥ Docker: ${{ secrets.DOCKER_USERNAME }}/qlorax-serve:${{ github.sha }}"
        echo ""
        echo "üìã Next Steps:"
        echo "   1. Pull the Docker container for deployment"
        echo "   2. Use the HuggingFace model for inference"
        echo "   3. Monitor performance metrics"