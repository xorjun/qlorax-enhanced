# ðŸš€ QLORAX Serving Container
# Dockerfile for production model deployment

FROM python:3.11-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV GRADIO_SERVER_NAME=0.0.0.0
ENV GRADIO_SERVER_PORT=7860

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements
COPY requirements.txt .
COPY requirements-instructlab.txt .

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir gradio>=4.0.0 fastapi uvicorn

# Copy application code
COPY scripts/ ./scripts/
COPY configs/ ./configs/
COPY data/ ./data/

# Copy trained models (will be mounted or copied during CI/CD)
COPY models/ ./models/

# Create necessary directories
RUN mkdir -p /app/results /app/logs

# Make scripts executable
RUN chmod +x scripts/*.py

# Expose ports
EXPOSE 7860 8000

# Health check for API server
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Create startup script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ðŸš€ Starting QLORAX Serving Container..."\n\
echo "Available models:"\n\
ls -la models/\n\
\n\
# Start API server in background\n\
echo "ðŸ”Œ Starting API server on port 8000..."\n\
python scripts/api_server.py &\n\
\n\
# Start Gradio interface\n\
echo "ðŸŒ Starting Gradio interface on port 7860..."\n\
python scripts/gradio_app.py --port 7860 --share\n\
' > /app/start_services.sh

RUN chmod +x /app/start_services.sh

# Default command
CMD ["/app/start_services.sh"]